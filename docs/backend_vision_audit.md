# 后端愿景对齐与改进记录

## 愿景核心要点速览
- 研究全流程支持三种模式：RAG 常规模式、深度研究模式、全自动模式。
- 文献建库需覆盖：AI 拆解 → 多源检索（ResearchRabbit、上传 PDF、DOI、Zotero 导入等）→ PDF 转 Markdown → 清洁化结构 → 迭代生成经验 → 入库同步。
- 长耗时流程必须后台任务化，并且提供前台/重新登录可见的进度。
- 交互需仿 Skywork：持续给出选项，超过 5 秒未响应默认执行推荐项。
- 完全移除 SQLite 依赖，仅使用 MySQL 存储。

## 本次审查要点
1. **文献检索与建库链路**：API、Service、任务流是否形成“原子化”流水线，是否可扩展至大批量。
2. **数据来源链路**：确认上传 / DOI / Zotero / ResearchRabbit 调用链路与愿景一致，排除遗留的多源爬虫代码。
3. **研究模式调度**：三种模式的差异化是否落地，尤其是深度研究模式的“仅基于问题相关片段再生成经验”。
4. **任务追踪与 5 秒交互**：后台任务、WebSocket 通知、超时默认选项是否齐备。

## 发现的问题与修复
- **搜索建库任务忽略了请求中的 query 关键词**：Celery 延迟任务仅使用 `request.keywords`，导致仅输入问题文本时实际搜索为空。
  - ✅ 已修复：统一使用整理后的关键词数组传递给任务与配置。
- **Pipeline 缺少最大处理数量约束**：`ProcessingConfig` 未携带 `max_results`，服务端始终按 500 条上限抓取，资源浪费且与付费层级策略不符。
  - ✅ 已修复：为配置新增 `max_results`，搜索阶段与去重阶段都会截断到目标数量。
- **仍残留旧版多源采集器代码**：主力接口依然引用“多源采集”实现，与当前仅使用 ResearchRabbit 的规划不符。
  - ✅ 已修复：替换为 ResearchRabbit 专用采集器，实现搜索→入库→PDF 处理闭环，并移除旧版多源抓取逻辑；会员配置和前台接口同步限定为 ResearchRabbit。
- **深度研究模式经验生成过度依赖全量段落**：`start_experience_generation_task` 未按问题筛选段落，与“针对问题迭代新的经验”目标不符。
  - ✅ 已修复：引入 `RAGService` 先检索问题相关的前 60 个段落，若无命中再退回全量。
- **其余设计与愿景的符合点**（仅列代表性）：
  - 搜索建库流水线 (`SearchAndBuildLibraryService`) 已按阶段拆分，支持并发下载、AI 筛选、结构化提取、ES 同步。
  - 上传 PDF、Zotero / RIS / BibTeX 导入、ResearchRabbit 检索入口齐备，并在导入后自动触发 Celery 处理任务。
  - 任务中心 (`TaskStreamService` + WebSocket) 统一更新状态，`/api/intelligent_interaction` 落地了 5 秒超时自动选择逻辑。

## 后续建议
1. **深度模式体验补全**：经验生成完成后自动触发一次问答响应（或通过任务链路调度），提供闭环反馈。
2. **经验引擎性能观测**：当前仍可能在文献很多时退回全量段落，建议新增批次上限（例如 200 段）与指标监控。
3. **搜索参数联动**：前端需显式传入经清洗后的关键词数组，避免再度出现 query 遗漏；同时可展示后台实际使用的关键词与数量。
4. **任务结果持久化梳理**：确认 `Task.result` 在所有阶段都写入结构化 JSON，便于前端重连后恢复进度视图。
5. **MySQL 专用脚本**：现已移除 SQLite，后续如有迁移脚本需统一检视 `sql/` 与 `scripts/` 目录是否仍有 SQLite 语句。

## 验证建议
- 重新执行 `/api/literature/search-and-build-library`，仅传 `query` 字段，确认后台日志与数据库入库数量符合会员限制。
- 使用 `docs/backend_test_guide.md` 的流程，在 MySQL 环境跑通 RAG、深度、全自动模式，重点查看经验生成任务的段落数量与关联项目。
- 手动调用 `/api/interaction/{session_id}/timeout` 检查 5 秒自动选择是否能正确推进任务。

---
最后更新时间：`$(date '+%Y-%m-%d %H:%M:%S')`
